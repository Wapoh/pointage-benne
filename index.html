<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Pointage Benne ‚Äî Mobile SAFE</title>
<meta name="theme-color" content="#0b57d0"/>
<style>
  :root { --brand:#0b57d0; }
  * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  body { margin:0; background:#f5f7fb; color:#0f172a; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  header { position:sticky; top:0; background:var(--brand); color:#fff; padding:14px 16px; }
  main { padding:16px; max-width:720px; margin:auto; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:16px; margin:12px 0; }
  label { display:block; margin:10px 0 6px; font-weight:700; }
  input[type=text] { width:100%; padding:14px; border:1px solid #cbd5e1; border-radius:12px; font-size:16px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  button { padding:14px 18px; border-radius:14px; border:1px solid #e5e7eb; background:#0b57d0; color:#fff; font-weight:700; font-size:16px; flex:1; cursor:pointer; }
  button.secondary { background:#0f172a; }
  #toast { position:fixed; top:12px; right:12px; padding:12px 14px; border-radius:14px; font-weight:700; color:#fff; display:none; z-index:10001; }
  #toast.ok { background:#16a34a; } #toast.warn { background:#f59e0b; } #toast.err { background:#ef4444; }
</style>
</head>
<body>
<header>
  <h1 style="margin:0;font-size:20px">üìç Pointage Benne</h1>
</header>

<div id="toast"></div>

<main>
  <div class="card">
    <label for="driver">Nom du conducteur</label>
    <input id="driver" type="text" autocomplete="name" placeholder="ex. Dupont Jean"/>
    <label for="bin">ID de la benne</label>
    <input id="bin" type="text" placeholder="ex. BENNE-123"/>
    <label for="plaque">Plaque / Tourn√©e</label>
    <input id="plaque" type="text" placeholder="ex. AB-123-CD ou Tourn√©e 5"/>
    <div class="row" style="margin-top:12px">
      <button id="btnSave" type="button">üíæ Enregistrer & pointer</button>
      <button id="btnFlush" type="button" class="secondary">üì§ Retenter envois</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnExport" type="button" class="secondary">Exporter hors-ligne</button>
      <button id="btnClear" type="button" class="secondary">üßπ Vider hors-ligne</button>
    </div>
  </div>
</main>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwcCrLFhTPcT2NhtLPe1d7UwX2yNHaXEVp89cYEodktviQaB0CDGRbvGFXxXXTxHnM6/exec";
const ID_KEY="gps_id_safe_v1", Q_KEY="gps_q_safe_v1", OFF_KEY="gps_off_safe_v1";

function toast(msg,kind){ const t=document.getElementById('toast'); t.textContent=msg; t.className=kind||''; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); }

function loadQ(){ try{return JSON.parse(localStorage.getItem(Q_KEY)||'[]');}catch(_ ){return[];} }
function saveQ(q){ localStorage.setItem(Q_KEY, JSON.stringify(q)); }
function appendOffline(p){ try{ const prev=localStorage.getItem(OFF_KEY)||''; localStorage.setItem(OFF_KEY, prev+JSON.stringify(p)+'\\n'); }catch(_ ){} }
function clearOffline(){ localStorage.removeItem(OFF_KEY); toast('Hors-ligne vid√©','ok'); }
function exportOffline(){ const blob=new Blob([localStorage.getItem(OFF_KEY)||'' ],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='points_offline.txt'; a.click(); toast('Export pr√™t','ok'); }

async function reverseGeocode(lat,lon){ try{ const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=18&addressdetails=1&accept-language=fr`; const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) throw 0; const j=await r.json(); return j.display_name||''; }catch(_ ){ return ''; } }

async function postPoint(payload){ try{ const body=new URLSearchParams(Object.entries(payload).map(([k,v])=>[k,String(v??'')])); await fetch(ENDPOINT,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body}); return true; }catch(_ ){ return false; } }

async function captureAndSend(){ if(location.protocol!=='https:'){ toast('Ouvre en HTTPS', 'err'); return; } if(!navigator.geolocation){ toast('GPS non support√©', 'err'); return; }
  const driver_name=(document.getElementById('driver').value||'').trim();
  const bin_id=(document.getElementById('bin').value||'').trim();
  const plaque=(document.getElementById('plaque').value||'').trim();
  if(!driver_name||!bin_id){ toast('Nom + ID benne requis','err'); return; }
  localStorage.setItem(ID_KEY, JSON.stringify({driver_name,bin_id,plaque}));
  try{ const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:20000,maximumAge:0})); const lat=pos.coords.latitude, lon=pos.coords.longitude; const address=await reverseGeocode(lat,lon);
    const payload={ driver_name, bin_id, plaque: plaque||'', address, latitude:String(lat), longitude:String(lon) };
    const ok=await postPoint(payload); toast(ok?'‚úÖ Pointage enregistr√©':'üì¥ Hors-ligne ‚Äî stock√©', ok?'ok':'warn');
    if(!ok){ const q=loadQ(); q.push(payload); saveQ(q); appendOffline(payload); }
  }catch(_ ){ toast('GPS indisponible','err'); }
}

async function flushQueue(){ const q=loadQ(); if(q.length===0){ toast('Rien √† envoyer','ok'); return; } let ok=0,fail=0; for(const item of [...q]){ const sent=await postPoint(item); if(sent){ q.shift(); saveQ(q); ok++; await new Promise(r=>setTimeout(r,120)); } else { fail++; await new Promise(r=>setTimeout(r,200)); } } toast(`Flush: ${ok} OK / ${fail} KO`, fail?'warn':'ok'); }

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnSave').addEventListener('click', captureAndSend);
  document.getElementById('btnFlush').addEventListener('click', flushQueue);
  document.getElementById('btnExport').addEventListener('click', exportOffline);
  document.getElementById('btnClear').addEventListener('click', clearOffline);
});
</script>
</body>
</html>
