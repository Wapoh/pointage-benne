<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Pointage Benne</title>
<meta name="theme-color" content="#0b57d0"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<style>
  :root{--brand:#0b57d0;--bg:#0a0a0a;--card:#ffffff}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;background:#f5f7fb;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;padding:14px 16px;padding-top:calc(14px + env(safe-area-inset-top))}
  header h1{margin:0;font-size:20px;letter-spacing:.2px}
  main{padding:16px;max-width:720px;margin:auto}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  label{display:block;margin:10px 0 6px;font-weight:700;font-size:15px}
  input[type=text]{width:100%;padding:14px 16px;border:1px solid #cbd5e1;border-radius:12px;font-size:17px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  button{flex:1 1 auto;padding:14px 18px;border-radius:14px;border:1px solid #e5e7eb;background:#0f172a;color:#fff;font-weight:700;font-size:17px}
  button.primary{background:#0b57d0;border-color:#0b57d0}
  .hint{color:#475569;font-size:13px;margin-top:6px}
  /* hidden endpoint panel */
  #settings{display:none;position:fixed;top:12px;right:12px;width:min(96vw,520px);max-height:85vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;z-index:9998;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #hot{position:fixed;top:0;left:0;width:44px;height:44px;background:transparent;z-index:10000}
  /* toast */
  #toast{position:fixed;top:12px;right:12px;padding:12px 14px;border-radius:14px;font-weight:700;color:#fff;display:none;z-index:10001}
  #toast.ok{background:#16a34a} #toast.warn{background:#f59e0b} #toast.err{background:#ef4444}
</style>
</head>
<body>
<header>
  <h1>üìç Pointage Benne</h1>
</header>

<div id="toast"></div>
<div id="hot" title="Triple-clic pour param√®tres"></div>

<!-- Param√®tres cach√©s (endpoint uniquement) -->
<div id="settings" class="card">
  <h3 style="margin-top:0">‚öôÔ∏è Param√®tres (Endpoint)</h3>
  <label for="endpoint">Endpoint (URL /exec)</label>
  <input id="endpoint" type="text" placeholder="https://script.google.com/macros/s/.../exec"/>
  <div class="row" style="margin-top:12px">
    <button class="primary" onclick="saveEndpoint()">üíæ Enregistrer</button>
    <button onclick="loadEndpoint(true)">‚Ü∫ Recharger</button>
    <button onclick="toggleSettings(false)">‚ùå Fermer</button>
  </div>
  <p class="hint">Astuce : triple‚Äëclic dans le coin haut‚Äëgauche pour rouvrir ces param√®tres.</p>
</div>

<main>
  <div class="card">
    <label for="driver">Nom du conducteur</label>
    <input id="driver" type="text" inputmode="text" autocomplete="name" placeholder="ex. Dupont Jean"/>
    <label for="bin">ID de la benne</label>
    <input id="bin" type="text" inputmode="text" placeholder="ex. BENNE-123"/>
    <label for="plaque">Plaque / Tourn√©e</label>
    <input id="plaque" type="text" inputmode="text" placeholder="ex. AB-123-CD ou Tourn√©e 5"/>
    <div class="row" style="margin-top:16px">
      <button class="primary" onclick="saveIdentityAndPoint()">üíæ Enregistrer & pointer</button>
      <button onclick="flushQueue()">üì§ Retenter envois</button>
    </div>
    <p class="hint">Ajoute cette page √† l‚Äô√©cran d‚Äôaccueil pour un acc√®s 1‚Äëclic.</p>
  </div>

  <div class="card">
    <div class="row">
      <button onclick="exportOffline()">Exporter hors‚Äëligne</button>
      <button onclick="clearOffline()">üßπ Vider hors‚Äëligne</button>
    </div>
  </div>
</main>

<script>
const DEFAULT_ENDPOINT = "https://script.google.com/macros/s/AKfycbwcCrLFhTPcT2NhtLPe1d7UwX2yNHaXEVp89cYEodktviQaB0CDGRbvGFXxXXTxHnM6/exec";
const APP_NAME = "Pointage Benne";
const CFG_KEY="gps_cfg_mobile_v1", ID_KEY="gps_id_mobile_v1", Q_KEY="gps_q_mobile_v1", OFF_KEY="gps_off_mobile_v1";

function loadCfg(){ try{const r=localStorage.getItem(CFG_KEY); if(r) return JSON.parse(r);}catch(_ ){} return {endpoint:DEFAULT_ENDPOINT}; }
function saveCfg(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }
function loadEndpoint(toast){ const cfg=loadCfg(); document.getElementById('endpoint').value=cfg.endpoint||''; if(toast) toast('Endpoint charg√©','ok'); }
function saveEndpoint(){ const ep=(document.getElementById('endpoint').value||'').trim(); if(!/^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9\-_]+\/exec$/.test(ep)){ toast('Endpoint invalide','err'); return; } saveCfg({endpoint:ep}); toast('Endpoint enregistr√©','ok'); }

let clicks=0, t=null; document.getElementById('hot').addEventListener('click',()=>{ clicks++; if(t) clearTimeout(t); t=setTimeout(()=>clicks=0,600); if(clicks>=3){ clicks=0; toggleSettings(true); } });
function toggleSettings(show){ document.getElementById('settings').style.display = show?'block':'none'; if(show) loadEndpoint(false); }

let tt=null; function toast(msg,kind){ const el=document.getElementById('toast'); el.textContent=msg; el.className=kind||''; el.style.display='block'; if(tt) clearTimeout(tt); tt=setTimeout(()=>el.style.display='none',2500); }

function loadIdentity(){ let o={driver_name:'',bin_id:'',plaque:''}; try{const r=localStorage.getItem(ID_KEY); if(r) o=JSON.parse(r);}catch(_ ){} document.getElementById('driver').value=o.driver_name||''; document.getElementById('bin').value=o.bin_id||''; document.getElementById('plaque').value=o.plaque||''; }
async function saveIdentityAndPoint(){ const driver=(document.getElementById('driver').value||'').trim(); const bin=(document.getElementById('bin').value||'').trim(); const plaque=(document.getElementById('plaque').value||'').trim(); if(!driver||!bin){ toast('Nom + ID benne requis','err'); return; } localStorage.setItem(ID_KEY, JSON.stringify({driver_name:driver, bin_id:bin, plaque})); await captureAndSend(); }

function loadQ(){ try{return JSON.parse(localStorage.getItem(Q_KEY)||'[]');}catch(_ ){return[];} }
function saveQ(q){ localStorage.setItem(Q_KEY, JSON.stringify(q)); }
function appendOffline(p){ try{ const prev=localStorage.getItem(OFF_KEY)||''; localStorage.setItem(OFF_KEY, prev+JSON.stringify(p)+'\n'); }catch(_ ){} }
function clearOffline(){ localStorage.removeItem(OFF_KEY); toast('Hors-ligne vid√©','ok'); }
function exportOffline(){ const blob=new Blob([localStorage.getItem(OFF_KEY)||'' ],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='points_offline.txt'; a.click(); toast('Export pr√™t','ok'); }

async function flushQueue(){ const ep=loadCfg().endpoint; let q=loadQ(); if(q.length===0){ toast('Rien √† envoyer','ok'); return; } let ok=0,fail=0; for(const item of [...q]){ try{ const body=new URLSearchParams(Object.entries(item).map(([k,v])=>[k,String(v??'')])); const r=await fetch(ep,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body}); if(!(r.ok||r.type==='opaque')) throw new Error('HTTP '+(r.status||'opaque')); ok++; q.shift(); saveQ(q); await new Promise(r=>setTimeout(r,120)); }catch(_ ){ fail++; await new Promise(r=>setTimeout(r,200)); } } toast(`Flush: ${ok} envoy√©s, ${fail} √©checs`, fail?'warn':'ok'); }

async function reverseGeocode(lat,lon){ const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${{encodeURIComponent(lat)}}&lon=${{encodeURIComponent(lon)}}&zoom=18&addressdetails=1&accept-language=fr`; const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),8000); try{ const r=await fetch(url,{signal:ctrl.signal,headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('geocode '+r.status); const j=await r.json(); return j.display_name||''; }catch(_ ){ return ''; } finally{ clearTimeout(to); } }

async function captureAndSend(){ const cfg=loadCfg(); let ident={driver_name:'',bin_id:'',plaque:''}; try{const raw=localStorage.getItem(ID_KEY); if(raw) ident=JSON.parse(raw);}catch(_ ){} if(!ident.driver_name||!ident.bin_id){ toast('Nom + ID benne requis','err'); return; } if(!navigator.geolocation){ toast('GPS non support√©','err'); return; } try{ const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:15000,maximumAge:0})); const lat=pos.coords.latitude, lon=pos.coords.longitude; const address=await reverseGeocode(lat,lon); const payload={{ driver_name:ident.driver_name, bin_id:ident.bin_id, plaque:ident.plaque||'', address, latitude:String(lat), longitude:String(lon) }}; const body=new URLSearchParams(Object.entries(payload).map(([k,v])=>[k,String(v??'')])); const r=await fetch(cfg.endpoint,{method:'POST',mode:'no-cors',headers:{{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}},body}); if(!(r.ok||r.type==='opaque')) throw new Error('HTTP '+(r.status||'opaque')); toast('‚úÖ Pointage enregistr√©', 'ok'); }catch(e){ const q=loadQ(); /* on n'empile que si on a lat/lon */ try{{ if(typeof lat!=='undefined' && typeof lon!=='undefined'){{ const address = await reverseGeocode(lat,lon).catch(()=>'' ); q.push({{ driver_name:ident.driver_name, bin_id:ident.bin_id, plaque:ident.plaque||'', address, latitude:String(lat), longitude:String(lon) }}); saveQ(q); appendOffline(q[q.length-1]); }} }}catch(_ ){{}} toast('Hors-ligne ‚Äî stock√©', 'warn'); } }

document.addEventListener('DOMContentLoaded',()=>{ loadIdentity(); loadEndpoint(false); });
</script>
</body>
</html>
